<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ”¹å¯†ç é¡µé¢</title>
    <link rel="stylesheet" href="css/commen.css">
    <link rel="stylesheet" href="css/reset_newPwd.css">
    <script src="js/jquery.min.js"></script>
</head>
<body>
<div class="nav">
    <img src="image/head.png" alt="">
    <span>æˆ‘çš„åšå®¢ç³»ç»Ÿ</span>
    <!-- å ä½ç›’å­ -->
    <div class="space"></div>
    <a href="reg.html">æ³¨å†Œ</a>
    <a href="blog_list.html">ä¸»é¡µ</a>
    <a href="blog_edit.html">å†™åšå®¢</a>
</div>

<div class="login-container">
    <div class="login-dialog">
        <div id="information">
            <div class="row" id="imgrow">
                <img src="image/head.png">
            </div>
            <h3 id="title">é‡ç½®å¯†ç </h3>
            <div class="row" id="spanContent">
                <span>è¯·é€šè¿‡è¾“å…¥ç”¨æˆ·å/å®‰å…¨é—®é¢˜é‡ç½®ä½ çš„åšå®¢è´¦å·å¯†ç </span>
            </div>
            <div id="red">

            </div>
            <div class="row">
                <input id="question" placeholder="ğŸ“«  ç”¨æˆ·å/å®‰å…¨é—®é¢˜">
            </div>
            <div class="row">
                <button id="resetPwd" onclick="javascript:findQuestion()">é‡ç½®å¯†ç </button>
            </div>
        </div>
    </div>
</div>
<script>

    function findQuestion() {
        var question = jQuery("#question");
        if (question.val() === "") {
            jQuery("#red").html(
                '<div class="row">' +
                '<div id="redback">' +
                '<span>è¯¥å­—æ®µå¿…å¡«</span>' +
                '</div>' +
                '</div>'
            )
            return;
        }
        //å¦‚æœä¸ä¸ºç©º,è·å–ä¿¡æ¯è¿”å›ç»™åç«¯åˆ¤æ–­ç”¨æˆ·åå¯¹åº”çš„å®‰å…¨é—®é¢˜æ˜¯å¦æ­£ç¡®
        jQuery.ajax({
            url: "/user/findques",
            type: "POST",
            // ä¼ ç»™åç«¯è¿˜éœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯é—®é¢˜, æœ‰å¯èƒ½æ˜¯ç”¨æˆ·å
            data: {"securityquestion": question.val()},
            success: function (result) {
                if (result != null) {
                    if (result.code === -1) {
                        jQuery("#red").html(
                            '<div class="row">' +
                            '<div id="redback">' +
                            '<span>ç”¨æˆ·ä¸å­˜åœ¨</span>' +
                            '</div>' +
                            '</div>'
                        )
                        return;
                    }
                    // è¯´æ˜é€šè¿‡ä¿¡æ¯æŸ¥æ‰¾åˆ°ç”¨æˆ·äº†
                    if (result.code === 200) {
                        // å¼€å§‹é€šè¿‡ä¿¡æ¯æ„é€ å‰ç«¯
                        jQuery('#information').html(
                            '<div class="row" id="imgrow">\n' +
                            '                <img src="image/head.png">\n' +
                            '            </div>\n' +
                            '            <h3 id="title">é‡ç½®å¯†ç </h3>\n' +
                            '            <div id="red">\n' +
                            '\n' +
                            '            </div>\n' +
                            '            <div class="row">\n' +
                            '            <h3 id="question">' + result.data.securityquestion + '</h3>\n' +
                            '            </div>\n' +
                            '            <div class="row">\n' +
                            '                <input id="answer" placeholder="ğŸ”‘ ">\n' +
                            '            </div>\n' +
                            '            <div class="row">\n' +
                            '                <button id="resetPwd" onclick="javascript:confirmAnswer(' + result.data.id + ')">ç¡®å®š</button>\n' +
                            '            </div>'
                        )
                    }
                }
            }
        });
    }

    // è·å–ç¡®è®¤ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®
    function confirmAnswer(id) {
        let securityquestion = jQuery("#question");
        let securityanswer = jQuery("#answer");
        if (securityanswer.val() === "") {
            jQuery("#red").html(
                '<div class="row">' +
                '<div id="redback">' +
                '<span>è¯¥å­—æ®µå¿…å¡«</span>' +
                '</div>' +
                '</div>'
            )
            securityanswer.focus();
            return;
        }
        //å¼€å§‹å‘åç«¯ä¼ é€’æ•°æ®
        jQuery.ajax({
            url: "/user/confirmans",
            type: "POST",
            data: {"securityquestion": securityquestion.text(), "securityanswer": securityanswer.val()},
            success: function (result) {
                if (result != null) {
                    if (result.code === -3) {
                        jQuery("#red").html(
                            '<div class="row">' +
                            '<div id="redback">' +
                            '<span>å®‰å…¨é—®é¢˜ä¸å¯¹!</span>' +
                            '</div>' +
                            '</div>'
                        )
                    }
                    if (result.code === 200) {
                        // è¯´æ˜å¯ä»¥è¿›è¡Œä¿®æ”¹å¯†ç äº†!
                        jQuery('#information').html(
                            '<div class="row" id="imgrow">\n' +
                            '                <img src="image/head.png">\n' +
                            '            </div>\n' +
                            '            <h3 id="title">é‡ç½®å¯†ç </h3>\n' +
                            '            <div class="row" id="spanContent">\n' +
                            '                <span>è¯·è¾“å…¥æ–°å¯†ç ä»¥é‡ç½®åšå®¢è´¦å·å¯†ç </span>\n' +
                            '            </div>\n' +
                            '            <div id="red">\n' +
                            '\n' +
                            '            </div>\n' +
                            '            <div class="row">\n' +
                            '                <input id="password" placeholder="ğŸ”’ æ–°å¯†ç ">\n' +
                            '            </div>\n' +
                            '            <div class="row">\n' +
                            '                <input id="confirmPwd" placeholder="ğŸ”’ å†æ¬¡è¾“å…¥æ–°å¯†ç ">\n' +
                            '            </div>\n' +
                            '            <div class="row">\n' +
                            '                <button id="resetPwd" onclick="javascript:resetPassword(' + id + ')">é‡ç½®å¯†ç </button>\n' +
                            '            </div>'
                        );
                    }
                }
            }
        });
    }

    function resetPassword(id) {
        // æ¥æ”¶åˆ°åç«¯ä¼ æ¥çš„idä¿¡æ¯
        var newPassword = jQuery("#password");
        var newPassword2 = jQuery("#confirmPwd");
        if (newPassword.val() === '' || newPassword2.val() === '') {
            jQuery("#red").html(
                '<div class="row">' +
                '<div id="redback">' +
                '<span>è¯¥å­—æ®µå¿…å¡«</span>' +
                '</div>' +
                '</div>'
            );
            return;
        }
        if (newPassword.val() !== newPassword2.val()) {
            jQuery("#red").html(
                '<div class="row">' +
                '<div id="redback">' +
                '<span>ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´</span>' +
                '</div>' +
                '</div>'
            );
            return;
        }
        jQuery.ajax({
            url: "user/resetpwd",
            type: "POST",
            data: {"id": id, "password": newPassword.val()},
            success: function (result) {
                if (result != null) {
                    if (result.code === 200) {
                        alert("ä¿®æ”¹æˆåŠŸè½¬è·³é¡µé¢");
                        location.href = "blog_login.html";
                    }
                }
            }
        });
    }
</script>
</body>
</html>